<?xml version="1.0" encoding="utf-8"?>
<odoo>
  <template id="recv_dashboard_page" name="Receivables Dashboard Page">
    <t t-call="web.layout">
      <t t-set="title">Receivables Dashboard</t>
      <t t-call-assets="web.assets_backend" t-js="false"/>
      <t t-call-assets="web.assets_backend" t-css="false"/>

      <!-- number formatter -->
      <t t-set="fmt" t-value="lambda n: ('{:,.3f}'.format(float(n or 0.0)))"/>

      <div class="o_mssql_recv">

        <!-- back button (inside layout) -->
        <div class="o_recv__topbar">
          <a href="/web#home" class="btn btn-light btn-sm o_recv__back">← Back to Home</a>
        </div>

        <h2>Receivables Dashboard</h2>

        <!-- top bar: last updated + refresh -->
        <div class="o_recv__refreshbar">
          <span class="o_recv__stamp">
            Last updated: <strong t-esc="updated_at"/>
          </span>
          <button id="recv_refresh" type="button" class="btn btn-secondary btn-sm">Refresh</button>
          <span id="recv_refresh_status" class="o_recv__note"></span>
        </div>

        <!-- tabs -->
        <div class="o_recv__nav" style="margin-top:.5rem;">
          <a href="/recv/dashboard" class="tab active" aria-current="page">Dashboard</a>
          <a href="/recv/charts" class="tab">Charts</a>
        </div>

        <!-- summary cards (clickable) -->
        <div class="o_example_cards">
          <!-- Current -->
          <a class="o_card o_card--current" href="/recv/bucket/current">
            <div class="o_card_title">Current</div>
            <div class="o_card_value" t-esc="fmt(totals.get('current'))"/>
          </a>

          <!-- 1–30 -->
          <a class="o_card o_card--d0_30" href="/recv/bucket/d0_30">
            <div class="o_card_title">1–30 Days</div>
            <div class="o_card_value" t-esc="fmt(totals.get('d0_30'))"/>
          </a>

          <!-- 31–60 -->
          <a class="o_card o_card--d31_60" href="/recv/bucket/d31_60">
            <div class="o_card_title">31–60 Days</div>
            <div class="o_card_value" t-esc="fmt(totals.get('d31_60'))"/>
          </a>

          <!-- 61–90 -->
          <a class="o_card o_card--d61_90" href="/recv/bucket/d61_90">
            <div class="o_card_title">61–90 Days</div>
            <div class="o_card_value" t-esc="fmt(totals.get('d61_90'))"/>
          </a>

          <!-- 90+ -->
          <a class="o_card o_card--d90p" href="/recv/bucket/d90p">
            <div class="o_card_title">90+ Days</div>
            <div class="o_card_value" t-esc="fmt(totals.get('d90p'))"/>
          </a>

          <!-- Total -->
          <div class="o_card">
            <div class="o_card_title">Total Receivables</div>
            <div class="o_card_value" t-esc="fmt(totals.get('total'))"/>
          </div>
        </div> <!-- /.o_example_cards -->

        <!-- ===== Receivables table toolbar ===== -->
        <div class="o-recv-tools">
          <div class="o-recv-tools__left">
            <input id="recvSearch" class="o-recv-input" type="search" placeholder="Search customers… (min 2 chars)"/>
            <button id="recvClear" class="btn btn-light btn-sm" type="button">Clear</button>
          </div>
          <div class="o-recv-tools__right">
            <select id="recvZero" class="o-recv-select">
              <option value="show_zero">Show zero-total rows</option>
              <option value="hide_zero">Hide zero-total rows</option>
            </select>
          </div>
        </div>

        <!-- ===== Receivables table ===== -->
        <table id="recv_table" class="o_recv__table table table-sm table-striped">
          <!-- Fixed column widths so header & rows always align -->
          <colgroup>
            <col class="o-recv-col--serial"/>
            <col class="o-recv-col--name"/>
            <col class="o-recv-col--amt"/><!-- Current -->
            <col class="o-recv-col--amt"/><!-- 1–30  -->
            <col class="o-recv-col--amt"/><!-- 31–60 -->
            <col class="o-recv-col--amt"/><!-- 61–90 -->
            <col class="o-recv-col--amt"/><!-- 90+   -->
            <col class="o-recv-col--amt"/><!-- Total -->
          </colgroup>

          <thead>
            <tr>
              <th class="serial text-center">#</th>
              <th>Customer</th>
              <th class="text-end">Current</th>
              <th class="text-end">1–30</th>
              <th class="text-end">31–60</th>
              <th class="text-end">61–90</th>
              <th class="text-end">90+</th>
              <th class="text-end">Total</th>
            </tr>
          </thead>

          <tbody>
            <!-- safer than relying on idx; we maintain our own serial -->
            <t t-set="serial" t-value="0"/>
            <t t-foreach="rows or []" t-as="r">
              <t t-set="serial" t-value="serial + 1"/>
              <tr class="o-recv-row"
                  t-att-data-customer_code="r.get('customer_code')"
                  t-att-data-customer_name="r.get('customer_name')">
                <td class="num text-center" t-esc="serial"/>
                <td t-esc="r.get('customer_name') or r.get('customer')"/>
                <td class="num col-current" t-esc="fmt(r.get('current'))"/>
                <td class="num col-d0_30" t-esc="fmt(r.get('d0_30'))"/>
                <td class="num col-d31_60" t-esc="fmt(r.get('d31_60'))"/>
                <td class="num col-d61_90" t-esc="fmt(r.get('d61_90'))"/>
                <td class="num col-d90p"   t-esc="fmt(r.get('d90p'))"/>
                <td class="num"            t-esc="fmt(r.get('total'))"/>
              </tr>

              <!-- hidden expander row -->
              <tr class="o-recv-expand">
                <td colspan="8">
                  <div class="o-recv-expand__body"><!-- invoices filled by JS --></div>
                </td>
              </tr>
            </t>

            <tr t-if="not (rows and len(rows))">
              <td colspan="8" class="text-muted">No data.</td>
            </tr>
          </tbody>
        </table>

      </div> <!-- /.o_mssql_recv -->
    </t>
  </template>
</odoo>
